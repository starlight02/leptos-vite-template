name: Create Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for'
        required: true
        default: 'v0.1.0'
        type: string

permissions:
  contents: write
  actions: read
  id-token: write

concurrency:
  group: "release"
  cancel-in-progress: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version info
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          
          VERSION=${TAG_NAME#v}
          REPO_NAME="${{ github.event.repository.name }}"
          PACKAGE_NAME="${REPO_NAME}-${TAG_NAME}-wasm32-unknown-unknown.zip"
          
          if [[ "$VERSION" == *"-"* ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "full_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          
          echo "Building $TAG_NAME for $REPO_NAME"

      - name: Check existing release
        run: |
          if gh release view "${{ steps.version.outputs.tag_name }}" >/dev/null 2>&1; then
            echo "Release already exists, stopping"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      # é…ç½® pnpm ç¯å¢ƒå˜é‡
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # é…ç½® pnpm ä¾èµ–ç¼“å­˜
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£… Rust å·¥å…·é“¾
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown

      # é…ç½® Rust ä¾èµ–ç¼“å­˜
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # ç¼“å­˜ WASM å·¥å…·
      - name: Cache WASM tools
        id: cache-wasm-tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            /usr/local/bin/wasm-opt
            ~/.wasm-pack
          key: ${{ runner.os }}-wasm-tools-v3
          restore-keys: |
            ${{ runner.os }}-wasm-tools-

      # ç¡®ä¿ cargo bin åœ¨ PATH ä¸­
      - name: Setup PATH
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          mkdir -p ~/.cargo/bin

      # å®‰è£… wasm-packï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰
      - name: Install wasm-pack
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # å®‰è£… wasm-bindgen-cliï¼ˆä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼‰
      - name: Install wasm-bindgen-cli
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: |
          WASM_BINDGEN_VERSION="0.2.95"
          wget https://github.com/rustwasm/wasm-bindgen/releases/download/${WASM_BINDGEN_VERSION}/wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl.tar.gz
          tar -xzf wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl.tar.gz
          cp wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl/wasm-bindgen ~/.cargo/bin/
          cp wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl/wasm-bindgen-test-runner ~/.cargo/bin/
          chmod +x ~/.cargo/bin/wasm-bindgen
          chmod +x ~/.cargo/bin/wasm-bindgen-test-runner

      # å®‰è£… wasm-opt ä¼˜åŒ–å·¥å…·ï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰
      - name: Install wasm-opt
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: |
          BINARYEN_VERSION="version_118"
          wget https://github.com/WebAssembly/binaryen/releases/download/${BINARYEN_VERSION}/binaryen-${BINARYEN_VERSION}-x86_64-linux.tar.gz
          tar -xzf binaryen-${BINARYEN_VERSION}-x86_64-linux.tar.gz
          sudo cp binaryen-${BINARYEN_VERSION}/bin/wasm-opt /usr/local/bin/
          sudo chmod +x /usr/local/bin/wasm-opt

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        env:
          NODE_ENV: production
          VITE_ENV: production
        run: |
          echo "Building production release..."
          pnpm run build
          
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            echo "Build failed"
            exit 1
          fi
          
          echo "Build completed successfully"

      - name: Create release package
        run: |
          mkdir -p release-temp
          cp -r dist/* release-temp/
          
          cat > release-temp/README.md << EOF
          # ${{ steps.version.outputs.repo_name }} - ${{ steps.version.outputs.tag_name }}
          
          Production build for wasm32-unknown-unknown platform.
          
          ## Usage
          1. Extract the zip file
          2. Serve files with a web server
          3. Open index.html in browser
          EOF
          
          cd release-temp
          zip -r "../${{ steps.version.outputs.package_name }}" .
          cd ..
          
          # éªŒè¯ ZIP æ–‡ä»¶å®Œæ•´æ€§
          if [ ! -f "${{ steps.version.outputs.package_name }}" ]; then
            echo "Package creation failed"
            exit 1
          fi
          
          if ! unzip -t "${{ steps.version.outputs.package_name }}" >/dev/null 2>&1; then
            echo "Package is corrupted"
            exit 1
          fi
          
          echo "Package created: ${{ steps.version.outputs.package_name }}"

      - name: Generate checksums
        run: |
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          
          # ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ (æ ‡å‡†æ ¼å¼: hash + ä¸¤ä¸ªç©ºæ ¼ + æ–‡ä»¶å)
          sha256sum "$PACKAGE_NAME" > "${PACKAGE_NAME}.sha256"
          
          # ç”Ÿæˆ SHA1 æ ¡éªŒå’Œ (æ ‡å‡†æ ¼å¼: hash + ä¸¤ä¸ªç©ºæ ¼ + æ–‡ä»¶å)
          sha1sum "$PACKAGE_NAME" > "${PACKAGE_NAME}.sha1"
          
          echo "Generated checksums:"
          echo "SHA256:"
          cat "${PACKAGE_NAME}.sha256"
          echo "SHA1:"
          cat "${PACKAGE_NAME}.sha1"
          
          # éªŒè¯æ ¡éªŒå’Œæ–‡ä»¶æ ¼å¼
          echo "Verifying checksum files..."
          sha256sum -c "${PACKAGE_NAME}.sha256"
          sha1sum -c "${PACKAGE_NAME}.sha1"
          
          echo "Checksums verified successfully"

      - name: Generate changelog
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          REPO_NAME="${{ steps.version.outputs.repo_name }}"
          FULL_REPO="${{ steps.version.outputs.full_repo }}"
          IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^$TAG_NAME$" | head -n 1)
          
          # å¼€å§‹æ„å»º changelog
          CHANGELOG="# Release $TAG_NAME\n\n"
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            CHANGELOG="$CHANGELOG> âš ï¸ **This is a pre-release version**. It may contain experimental features or bugs.\n\n"
          fi
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # é¦–æ¬¡å‘å¸ƒ
            CHANGELOG="$CHANGELOG## ğŸ‰ Initial Release\n\n"
            CHANGELOG="$CHANGELOG### What's Included\n"
            CHANGELOG="$CHANGELOG- Complete $REPO_NAME application\n"
            CHANGELOG="$CHANGELOG- WebAssembly (WASM) optimized build\n"
            CHANGELOG="$CHANGELOG- Production-ready distribution\n"
            CHANGELOG="$CHANGELOG- Cross-platform compatibility\n\n"
            
            # è·å–æ‰€æœ‰æäº¤çš„ç»Ÿè®¡
            TOTAL_COMMITS=$(git rev-list --count HEAD)
            CHANGELOG="$CHANGELOG### ğŸ“Š Project Statistics\n"
            CHANGELOG="$CHANGELOG- Total commits: $TOTAL_COMMITS\n"
            CHANGELOG="$CHANGELOG- Build platform: wasm32-unknown-unknown\n"
            CHANGELOG="$CHANGELOG- Package format: ZIP with checksums\n\n"
          else
            # ç‰ˆæœ¬æ›´æ–°
            echo "Generating changelog from $PREVIOUS_TAG to $TAG_NAME"
            
            # è·å–æäº¤ä¿¡æ¯ï¼ŒåŒ…å«æ›´å¤šè¯¦ç»†ä¿¡æ¯
            COMMITS=$(git log --pretty=format:"%h|%s|%an|%ad" --date=short "$PREVIOUS_TAG..$TAG_NAME")
            
            if [ -z "$COMMITS" ]; then
              CHANGELOG="$CHANGELOG## What's Changed\n\n- No significant changes\n\n"
            else
              CHANGELOG="$CHANGELOG## What's Changed\n\n"
              
              # åˆ†ç±»å˜æ›´
              FEATURES=""
              FIXES=""
              DOCS=""
              CHORES=""
              OTHERS=""
              
              # å¤„ç†æ¯ä¸ªæäº¤
              while IFS='|' read -r hash subject author date; do
                [ -z "$hash" ] && continue
                
                # åˆ›å»ºæäº¤é“¾æ¥
                COMMIT_LINK="([${hash}](https://github.com/${FULL_REPO}/commit/${hash}))"
                FORMATTED_ITEM="- $subject by @$author $COMMIT_LINK"
                
                # ç®€å•åˆ†ç±»
                case "$subject" in
                  feat*|add*|implement*|"Add "*|"Implement "*)
                    FEATURES="$FEATURES\n$FORMATTED_ITEM"
                    ;;
                  fix*|"Fix "*|"Resolve "*|"Correct "*)
                    FIXES="$FIXES\n$FORMATTED_ITEM"
                    ;;
                  doc*|"Update "*README*|"Add "*doc*)
                    DOCS="$DOCS\n$FORMATTED_ITEM"
                    ;;
                  chore*|build*|ci*|"Update "*workflow*|"Bump "*)
                    CHORES="$CHORES\n$FORMATTED_ITEM"
                    ;;
                  *)
                    OTHERS="$OTHERS\n$FORMATTED_ITEM"
                    ;;
                esac
              done <<< "$COMMITS"
              
              # æ·»åŠ åˆ†ç±»çš„å˜æ›´
              if [ -n "$FEATURES" ]; then
                CHANGELOG="$CHANGELOG### âœ¨ New Features\n$FEATURES\n\n"
              fi
              
              if [ -n "$FIXES" ]; then
                CHANGELOG="$CHANGELOG### ğŸ› Bug Fixes\n$FIXES\n\n"
              fi
              
              if [ -n "$DOCS" ]; then
                CHANGELOG="$CHANGELOG### ğŸ“š Documentation\n$DOCS\n\n"
              fi
              
              if [ -n "$CHORES" ]; then
                CHANGELOG="$CHANGELOG### ğŸ”§ Maintenance\n$CHORES\n\n"
              fi
              
              if [ -n "$OTHERS" ]; then
                CHANGELOG="$CHANGELOG### ğŸ“‹ Other Changes\n$OTHERS\n\n"
              fi
              
              # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
              COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
              CHANGELOG="$CHANGELOG### ğŸ“Š Release Statistics\n"
              CHANGELOG="$CHANGELOG- Commits in this release: $COMMIT_COUNT\n"
              CHANGELOG="$CHANGELOG- Previous version: $PREVIOUS_TAG\n"
              CHANGELOG="$CHANGELOG- Release type: $([ "$IS_PRERELEASE" = "true" ] && echo "Pre-release" || echo "Stable")\n\n"
            fi
          fi
          
          # æ·»åŠ ä¸‹è½½å’ŒéªŒè¯è¯´æ˜
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          CHANGELOG="$CHANGELOG## ğŸ“¥ Download & Installation\n\n"
          CHANGELOG="$CHANGELOG### Files in this release:\n"
          CHANGELOG="$CHANGELOG- \`$PACKAGE_NAME\` - Main application package\n"
          CHANGELOG="$CHANGELOG- \`${PACKAGE_NAME}.sha256\` - SHA256 checksum\n"
          CHANGELOG="$CHANGELOG- \`${PACKAGE_NAME}.sha1\` - SHA1 checksum\n\n"
          
          CHANGELOG="$CHANGELOG### Installation steps:\n"
          CHANGELOG="$CHANGELOG1. Download \`$PACKAGE_NAME\`\n"
          CHANGELOG="$CHANGELOG2. Verify integrity: \`sha256sum -c ${PACKAGE_NAME}.sha256\`\n"
          CHANGELOG="$CHANGELOG3. Extract the ZIP file\n"
          CHANGELOG="$CHANGELOG4. Serve files with a web server\n"
          CHANGELOG="$CHANGELOG5. Open \`index.html\` in your browser\n\n"
          
          CHANGELOG="$CHANGELOG### System Requirements:\n"
          CHANGELOG="$CHANGELOG- Modern web browser with WebAssembly support\n"
          CHANGELOG="$CHANGELOG- Web server (for CORS compliance)\n"
          CHANGELOG="$CHANGELOG- No additional dependencies required\n\n"
          
          # æ·»åŠ é“¾æ¥
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG="$CHANGELOG---\n\n"
            CHANGELOG="$CHANGELOG**Full Changelog**: https://github.com/${FULL_REPO}/compare/${PREVIOUS_TAG}...${TAG_NAME}\n"
            CHANGELOG="$CHANGELOG**All Releases**: https://github.com/${FULL_REPO}/releases\n"
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo -e "$CHANGELOG" > CHANGELOG.md
          
          echo "Generated changelog for $TAG_NAME"
          echo "Changelog length: $(wc -l < CHANGELOG.md) lines"

      - name: Create GitHub Release
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          
          ARGS="--title \"$TAG_NAME\" --notes-file CHANGELOG.md"
          if [ "${{ steps.version.outputs.is_prerelease }}" = "true" ]; then
            ARGS="$ARGS --prerelease"
          fi
          
          eval "gh release create \"$TAG_NAME\" $ARGS"
          gh release upload "$TAG_NAME" "$PACKAGE_NAME" "${PACKAGE_NAME}.sha256" "${PACKAGE_NAME}.sha1"
          
          echo "Release created: https://github.com/${{ steps.version.outputs.full_repo }}/releases/tag/$TAG_NAME"
          echo ""
          echo "Files uploaded:"
          echo "- $PACKAGE_NAME"
          echo "- ${PACKAGE_NAME}.sha256"
          echo "- ${PACKAGE_NAME}.sha1"
          echo ""
          echo "To verify download integrity:"
          echo "  sha256sum -c ${PACKAGE_NAME}.sha256"
          echo "  sha1sum -c ${PACKAGE_NAME}.sha1"
        env:
          GH_TOKEN: ${{ github.token }}