name: Create Release

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶
on:
  push:
    tags:
      - "v*"

  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹ (ç”¨äºæµ‹è¯•)
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for'
        required: true
        default: 'v0.1.0'
        type: string
      debug:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean

# æƒé™è®¾ç½®
permissions:
  contents: write    # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release
  actions: read      # è¯»å– Actions ç›¸å…³ä¿¡æ¯
  id-token: write    # ç”¨äºèº«ä»½éªŒè¯

# ç¡®ä¿åªæœ‰ä¸€ä¸ªå‘å¸ƒä»»åŠ¡åŒæ—¶è¿è¡Œ
concurrency:
  group: "release"
  cancel-in-progress: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

      # æå–ç‰ˆæœ¬ä¿¡æ¯
      - name: Extract version info
        id: version
        run: |
          # ä» tag æˆ–æ‰‹åŠ¨è¾“å…¥è·å–ç‰ˆæœ¬
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          
          # æå–ç‰ˆæœ¬å· (å»æ‰ v å‰ç¼€)
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # æ£€æµ‹æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (åŒ…å« - çš„ç‰ˆæœ¬å·)
          if [[ "$VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            
            # æå–é¢„å‘å¸ƒæ ‡è¯†ç¬¦
            PRERELEASE_ID=${VERSION#*-}
            echo "prerelease_id=$PRERELEASE_ID" >> $GITHUB_OUTPUT
            
            # æå–åŸºç¡€ç‰ˆæœ¬å· (å»æ‰é¢„å‘å¸ƒæ ‡è¯†ç¬¦)
            BASE_VERSION=${VERSION%-*}
            echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "prerelease_id=" >> $GITHUB_OUTPUT
            echo "base_version=$VERSION" >> $GITHUB_OUTPUT
          fi
          
          # è§£æè¯­ä¹‰åŒ–ç‰ˆæœ¬å·ç»„ä»¶
          if [[ "$VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-.*)?$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
            
            echo "major=$MAJOR" >> $GITHUB_OUTPUT
            echo "minor=$MINOR" >> $GITHUB_OUTPUT
            echo "patch=$PATCH" >> $GITHUB_OUTPUT
            
            echo "âœ… Parsed semantic version: $MAJOR.$MINOR.$PATCH"
          else
            echo "âŒ Failed to parse semantic version components"
            exit 1
          fi
          
          # è·å–ä»“åº“ä¿¡æ¯
          REPO_NAME="${{ github.event.repository.name }}"
          REPO_OWNER="${{ github.repository_owner }}"
          FULL_REPO="${{ github.repository }}"
          
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "repo_owner=$REPO_OWNER" >> $GITHUB_OUTPUT
          echo "full_repo=$FULL_REPO" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ ‡å‡†åŒ–çš„æ–‡ä»¶å‘½å
          PACKAGE_NAME="${REPO_NAME}-${TAG_NAME}-wasm32-unknown-unknown.zip"
          CHECKSUM_NAME="${REPO_NAME}-${TAG_NAME}-checksums.txt"
          
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "checksum_name=$CHECKSUM_NAME" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆ Release æ ‡é¢˜å’Œæè¿°æ¨¡æ¿
          if [ "${{ steps.version.outputs.is_prerelease }}" = "true" ]; then
            RELEASE_TITLE="$TAG_NAME (Pre-release)"
            RELEASE_TYPE="Pre-release"
          else
            RELEASE_TITLE="$TAG_NAME"
            RELEASE_TYPE="Release"
          fi
          
          echo "release_title=$RELEASE_TITLE" >> $GITHUB_OUTPUT
          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          
          # è·å–å½“å‰æ—¶é—´æˆ³
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Version Information:"
          echo "  Tag: $TAG_NAME"
          echo "  Version: $VERSION"
          echo "  Base Version: ${{ steps.version.outputs.base_version }}"
          echo "  Major: $MAJOR, Minor: $MINOR, Patch: $PATCH"
          echo "  Is Prerelease: ${{ steps.version.outputs.is_prerelease }}"
          echo "  Prerelease ID: ${{ steps.version.outputs.prerelease_id }}"
          echo "  Repository: $REPO_NAME ($FULL_REPO)"
          echo "  Package Name: $PACKAGE_NAME"
          echo "  Checksum Name: $CHECKSUM_NAME"
          echo "  Release Title: $RELEASE_TITLE"
          echo "  Release Type: $RELEASE_TYPE"
          echo "  Timestamp: $TIMESTAMP"

      # éªŒè¯ç‰ˆæœ¬æ ¼å¼
      - name: Validate version format
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # éªŒè¯æ ‡ç­¾æ ¼å¼ (å¿…é¡»ä»¥ v å¼€å¤´)
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "Expected format: v1.2.3 or v1.2.3-beta.1"
            exit 1
          fi
          
          echo "âœ… Version format is valid: $TAG_NAME"

      # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒå Release
      - name: Check existing release
        id: check_release
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          
          # ä½¿ç”¨ GitHub CLI æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒå Release
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸  Release $TAG_NAME already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
            
            # è·å–ç°æœ‰ Release ä¿¡æ¯
            gh release view "$TAG_NAME" --json name,tagName,isPrerelease,publishedAt
          else
            echo "âœ… Release $TAG_NAME does not exist, proceeding with creation"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      # å¦‚æœ Release å·²å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­
      - name: Handle existing release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            echo "ğŸ”§ Debug mode: Continuing despite existing release"
          else
            echo "âŒ Release $TAG_NAME already exists. Stopping workflow."
            echo "To override, run this workflow manually with debug mode enabled."
            exit 1
          fi

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # è®¾ç½® pnpm åŒ…ç®¡ç†å™¨
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      # é…ç½® pnpm ç¯å¢ƒå˜é‡
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # é…ç½® pnpm ä¾èµ–ç¼“å­˜
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£… Rust å·¥å…·é“¾
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown

      # é…ç½® Rust ä¾èµ–ç¼“å­˜
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # ç¼“å­˜ WASM å·¥å…·
      - name: Cache WASM tools
        id: cache-wasm-tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            /usr/local/bin/wasm-opt
            ~/.wasm-pack
          key: ${{ runner.os }}-wasm-tools-v3
          restore-keys: |
            ${{ runner.os }}-wasm-tools-

      # ç¡®ä¿ cargo bin åœ¨ PATH ä¸­
      - name: Setup PATH
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          mkdir -p ~/.cargo/bin

      # å®‰è£… wasm-packï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰
      - name: Install wasm-pack
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: |
          curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      # å®‰è£… wasm-bindgen-cliï¼ˆä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼‰
      - name: Install wasm-bindgen-cli
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: |
          # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ä»¥ç¡®ä¿å…¼å®¹æ€§
          WASM_BINDGEN_VERSION="0.2.95"
          echo "Installing wasm-bindgen-cli version: $WASM_BINDGEN_VERSION"
          
          # ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬
          wget https://github.com/rustwasm/wasm-bindgen/releases/download/${WASM_BINDGEN_VERSION}/wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl.tar.gz
          tar -xzf wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl.tar.gz
          
          # å¤åˆ¶åˆ° cargo bin ç›®å½•
          cp wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl/wasm-bindgen ~/.cargo/bin/
          cp wasm-bindgen-${WASM_BINDGEN_VERSION}-x86_64-unknown-linux-musl/wasm-bindgen-test-runner ~/.cargo/bin/
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x ~/.cargo/bin/wasm-bindgen
          chmod +x ~/.cargo/bin/wasm-bindgen-test-runner
          
          # éªŒè¯å®‰è£…
          wasm-bindgen --version

      # å®‰è£… wasm-opt ä¼˜åŒ–å·¥å…·ï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰
      - name: Install wasm-opt
        if: steps.cache-wasm-tools.outputs.cache-hit != 'true'
        run: |
          # ä½¿ç”¨å›ºå®šç‰ˆæœ¬ä»¥ç¡®ä¿ç¨³å®šæ€§
          BINARYEN_VERSION="version_118"
          echo "Installing binaryen version: $BINARYEN_VERSION"
          
          wget https://github.com/WebAssembly/binaryen/releases/download/${BINARYEN_VERSION}/binaryen-${BINARYEN_VERSION}-x86_64-linux.tar.gz
          tar -xzf binaryen-${BINARYEN_VERSION}-x86_64-linux.tar.gz
          sudo cp binaryen-${BINARYEN_VERSION}/bin/wasm-opt /usr/local/bin/
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          sudo chmod +x /usr/local/bin/wasm-opt
          
          # éªŒè¯å®‰è£…
          wasm-opt --version

      # éªŒè¯å·¥å…·å®‰è£…
      - name: Verify WASM tools
        run: |
          echo "ğŸ”§ Verifying WASM tools installation:"
          echo "PATH: $PATH"
          echo "Checking wasm-pack..."
          wasm-pack --version
          echo "Checking wasm-bindgen..."
          wasm-bindgen --version
          echo "Checking wasm-opt..."
          wasm-opt --version

      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: |
          pnpm install --no-frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      # è¾“å‡ºæ„å»ºé…ç½®ä¿¡æ¯
      - name: Show build configuration
        run: |
          echo "ğŸ”¨ Release Build Configuration:"
          echo "  Repository: ${{ github.repository }}"
          echo "  Tag: ${{ steps.version.outputs.tag_name }}"
          echo "  Version: ${{ steps.version.outputs.version }}"
          echo "  Is Prerelease: ${{ steps.version.outputs.is_prerelease }}"
          echo "  Package Name: ${{ steps.version.outputs.package_name }}"
          echo "  Debug Mode: ${{ github.event.inputs.debug }}"
          echo ""
          echo "ğŸŒ Build Environment:"
          echo "  Runner OS: ${{ runner.os }}"
          echo "  Node.js version: $(node --version)"
          echo "  pnpm version: $(pnpm --version)"
          echo "  Rust version: $(rustc --version)"
          echo "  wasm-pack version: $(wasm-pack --version)"
          echo "  GitHub Event: ${{ github.event_name }}"
          echo "  Workflow: ${{ github.workflow }}"
          echo "  Run ID: ${{ github.run_id }}"

      # æ„å»ºé¡¹ç›® - ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
      - name: Build project for production
        env:
          NODE_ENV: production
          GITHUB_ACTIONS: true
          # ç”Ÿäº§ç¯å¢ƒå˜é‡ - ä¸åŒ…å« GitHub Pages ç‰¹å®šé…ç½®
          VITE_ENV: production
          VITE_APP_TITLE: ${{ steps.version.outputs.repo_name }}
        run: |
          echo "ğŸ”¨ Starting production build process..."
          echo "Repository: ${{ github.repository }}"
          echo "Version: ${{ steps.version.outputs.tag_name }}"
          echo "Build type: Production Release (not GitHub Pages)"
          
          # æ˜¾ç¤ºæ„å»ºç¯å¢ƒä¿¡æ¯
          echo "ğŸŒ Production build environment:"
          echo "  NODE_ENV: $NODE_ENV"
          echo "  VITE_ENV: $VITE_ENV"
          echo "  VITE_APP_TITLE: $VITE_APP_TITLE"
          echo "  GITHUB_ACTIONS: $GITHUB_ACTIONS"
          
          # ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒæ„å»ºå‘½ä»¤
          echo "ğŸ“¦ Running production build..."
          pnpm run build
          
          echo "âœ… Production build completed successfully"

      # éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify build artifacts
        run: |
          echo "ğŸ” Verifying build artifacts..."
          
          # æ£€æŸ¥ dist ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist directory not found"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found in dist/"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ„å»ºç»Ÿè®¡
          echo "ğŸ“Š Build statistics:"
          echo "  Dist directory size: $(du -sh dist | cut -f1)"
          echo "  Number of files: $(find dist -type f | wc -l)"
          echo "  Total files size: $(find dist -type f -exec ls -l {} + | awk '{sum += $5} END {print sum " bytes"}')"
          
          # æ˜¾ç¤ºç›®å½•ç»“æ„
          echo "ğŸ“‚ Build output structure:"
          find dist -type f | head -20 | while read file; do
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "  $file ($size)"
          done
          
          # æ£€æŸ¥ WASM æ–‡ä»¶
          wasm_files=$(find dist -name "*.wasm" | wc -l)
          js_files=$(find dist -name "*.js" | wc -l)
          
          echo "ğŸ“‹ Asset summary:"
          echo "  WASM files: $wasm_files"
          echo "  JavaScript files: $js_files"
          echo "  CSS files: $(find dist -name "*.css" | wc -l)"
          echo "  HTML files: $(find dist -name "*.html" | wc -l)"
          
          if [ $wasm_files -eq 0 ]; then
            echo "âš ï¸  Warning: No WASM files found in build output"
          else
            echo "âœ… WASM files found in build output"
          fi
          
          echo "âœ… Build verification completed successfully"

      # æ„å»ºå®Œæ•´æ€§æ£€æŸ¥
      - name: Build integrity check
        run: |
          echo "ğŸ”’ Performing build integrity check..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºé”™è¯¯æˆ–è­¦å‘Šæ–‡ä»¶
          if [ -f "dist/build-errors.log" ]; then
            echo "âŒ Build errors detected:"
            cat dist/build-errors.log
            exit 1
          fi
          
          # éªŒè¯å…³é”®èµ„æºæ–‡ä»¶
          critical_files=("index.html")
          for file in "${critical_files[@]}"; do
            if [ ! -f "dist/$file" ]; then
              echo "âŒ Critical file missing: $file"
              exit 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            size=$(stat -c%s "dist/$file")
            if [ $size -eq 0 ]; then
              echo "âŒ Critical file is empty: $file"
              exit 1
            fi
            
            echo "âœ… Critical file verified: $file ($size bytes)"
          done
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«å¼€å‘ç¯å¢ƒç‰¹å®šçš„å†…å®¹
          if grep -r "localhost" dist/ 2>/dev/null; then
            echo "âš ï¸  Warning: Found localhost references in build output"
            grep -r "localhost" dist/ || true
          fi
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å« GitHub Pages ç‰¹å®šçš„è·¯å¾„
          if grep -r "github\.io" dist/ 2>/dev/null; then
            echo "âš ï¸  Warning: Found GitHub Pages references in build output"
            grep -r "github\.io" dist/ || true
          fi
          
          echo "âœ… Build integrity check passed"

      # åˆ›å»ºå‘å¸ƒåŒ…
      - name: Create release package
        run: |
          echo "ğŸ“¦ Creating release package..."
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          CHECKSUM_NAME="${{ steps.version.outputs.checksum_name }}"
          
          echo "Package name: $PACKAGE_NAME"
          echo "Checksum file: $CHECKSUM_NAME"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
          mkdir -p release-temp
          
          # å¤åˆ¶æ„å»ºäº§ç‰©åˆ°ä¸´æ—¶ç›®å½•
          echo "ğŸ“‚ Copying build artifacts..."
          cp -r dist/* release-temp/
          
          # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "ğŸ“ Creating version info file..."
          cat > release-temp/VERSION.txt << EOF
          Release Information
          ===================
          
          Tag: ${{ steps.version.outputs.tag_name }}
          Version: ${{ steps.version.outputs.version }}
          Build Date: ${{ steps.version.outputs.timestamp }}
          Repository: ${{ steps.version.outputs.full_repo }}
          Platform: wasm32-unknown-unknown
          Build Type: Production Release
          
          Components:
          - Major: ${{ steps.version.outputs.major }}
          - Minor: ${{ steps.version.outputs.minor }}
          - Patch: ${{ steps.version.outputs.patch }}
          - Is Prerelease: ${{ steps.version.outputs.is_prerelease }}
          - Prerelease ID: ${{ steps.version.outputs.prerelease_id }}
          
          Build Environment:
          - Node.js: $(node --version)
          - Rust: $(rustc --version)
          - wasm-pack: $(wasm-pack --version)
          - Runner: ${{ runner.os }}
          EOF
          
          # æ·»åŠ  README æ–‡ä»¶
          echo "ğŸ“– Creating package README..."
          cat > release-temp/README.md << EOF
          # ${{ steps.version.outputs.repo_name }} - ${{ steps.version.outputs.tag_name }}
          
          This is a production build of ${{ steps.version.outputs.repo_name }} for the wasm32-unknown-unknown platform.
          
          ## Installation
          
          1. Extract the zip file to your desired location
          2. Serve the files using a web server (due to CORS restrictions)
          3. Open \`index.html\` in your browser
          
          ## Files Included
          
          - \`index.html\` - Main application entry point
          - \`*.js\` - JavaScript modules and bindings
          - \`*.wasm\` - WebAssembly binary
          - \`*.css\` - Stylesheets
          - \`VERSION.txt\` - Build information
          
          ## Requirements
          
          - Modern web browser with WebAssembly support
          - Web server (for local development, use \`python -m http.server\` or similar)
          
          ## Build Information
          
          - Version: ${{ steps.version.outputs.version }}
          - Build Date: ${{ steps.version.outputs.timestamp }}
          - Platform: wasm32-unknown-unknown
          - Repository: https://github.com/${{ steps.version.outputs.full_repo }}
          EOF
          
          echo "âœ… Package preparation completed"

      # åˆ›å»º ZIP å‹ç¼©åŒ…
      - name: Create ZIP archive
        run: |
          echo "ğŸ—œï¸  Creating ZIP archive..."
          
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          
          # åˆ›å»º ZIP æ–‡ä»¶
          cd release-temp
          zip -r "../$PACKAGE_NAME" . -x "*.DS_Store" "*.git*"
          cd ..
          
          # éªŒè¯ ZIP æ–‡ä»¶
          if [ ! -f "$PACKAGE_NAME" ]; then
            echo "âŒ Failed to create ZIP file: $PACKAGE_NAME"
            exit 1
          fi
          
          # æ˜¾ç¤º ZIP æ–‡ä»¶ä¿¡æ¯
          ZIP_SIZE=$(ls -lh "$PACKAGE_NAME" | awk '{print $5}')
          ZIP_SIZE_BYTES=$(stat -c%s "$PACKAGE_NAME")
          
          echo "ğŸ“Š ZIP Archive Information:"
          echo "  File: $PACKAGE_NAME"
          echo "  Size: $ZIP_SIZE ($ZIP_SIZE_BYTES bytes)"
          echo "  Contents:"
          
          # æ˜¾ç¤º ZIP å†…å®¹
          unzip -l "$PACKAGE_NAME" | head -20
          
          echo "âœ… ZIP archive created successfully"

      # ç”Ÿæˆæ ¡éªŒå’Œ
      - name: Generate checksums
        run: |
          echo "ğŸ” Generating checksums..."
          
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          CHECKSUM_NAME="${{ steps.version.outputs.checksum_name }}"
          
          # ç”Ÿæˆå¤šç§æ ¡éªŒå’Œ
          echo "Generating SHA256 checksum..."
          SHA256_HASH=$(sha256sum "$PACKAGE_NAME" | cut -d' ' -f1)
          
          echo "Generating MD5 checksum..."
          MD5_HASH=$(md5sum "$PACKAGE_NAME" | cut -d' ' -f1)
          
          # åˆ›å»ºæ ¡éªŒå’Œæ–‡ä»¶
          cat > "$CHECKSUM_NAME" << EOF
          Checksums for $PACKAGE_NAME
          ============================
          
          Generated: ${{ steps.version.outputs.timestamp }}
          File Size: $(stat -c%s "$PACKAGE_NAME") bytes
          
          SHA256: $SHA256_HASH
          MD5:    $MD5_HASH
          
          Verification Instructions:
          -------------------------
          
          To verify the integrity of the downloaded file:
          
          Linux/macOS:
            sha256sum -c $CHECKSUM_NAME
            # or
            echo "$SHA256_HASH  $PACKAGE_NAME" | sha256sum -c
          
          Windows (PowerShell):
            \$hash = Get-FileHash -Algorithm SHA256 "$PACKAGE_NAME"
            \$hash.Hash -eq "$SHA256_HASH"
          EOF
          
          # éªŒè¯æ ¡éªŒå’Œæ–‡ä»¶
          if [ ! -f "$CHECKSUM_NAME" ]; then
            echo "âŒ Failed to create checksum file: $CHECKSUM_NAME"
            exit 1
          fi
          
          echo "ğŸ“‹ Checksum Information:"
          echo "  SHA256: $SHA256_HASH"
          echo "  MD5:    $MD5_HASH"
          echo "  File:   $CHECKSUM_NAME"
          
          echo "âœ… Checksums generated successfully"

      # éªŒè¯æ‰“åŒ…ç»“æœ
      - name: Validate package
        run: |
          echo "ğŸ” Validating release package..."
          
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          CHECKSUM_NAME="${{ steps.version.outputs.checksum_name }}"
          
          # æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$PACKAGE_NAME" ]; then
            echo "âŒ Package file not found: $PACKAGE_NAME"
            exit 1
          fi
          
          if [ ! -f "$CHECKSUM_NAME" ]; then
            echo "âŒ Checksum file not found: $CHECKSUM_NAME"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          PACKAGE_SIZE=$(stat -c%s "$PACKAGE_NAME")
          MIN_SIZE=1024  # æœ€å° 1KB
          MAX_SIZE=104857600  # æœ€å¤§ 100MB
          
          if [ $PACKAGE_SIZE -lt $MIN_SIZE ]; then
            echo "âŒ Package too small: $PACKAGE_SIZE bytes (minimum: $MIN_SIZE)"
            exit 1
          fi
          
          if [ $PACKAGE_SIZE -gt $MAX_SIZE ]; then
            echo "âš ï¸  Warning: Package is large: $PACKAGE_SIZE bytes (maximum recommended: $MAX_SIZE)"
          fi
          
          # éªŒè¯ ZIP æ–‡ä»¶å®Œæ•´æ€§
          echo "ğŸ” Testing ZIP integrity..."
          if ! unzip -t "$PACKAGE_NAME" >/dev/null 2>&1; then
            echo "âŒ ZIP file is corrupted"
            exit 1
          fi
          
          # éªŒè¯æ ¡éªŒå’Œ
          echo "ğŸ” Verifying checksums..."
          EXPECTED_SHA256=$(grep "SHA256:" "$CHECKSUM_NAME" | cut -d' ' -f2)
          ACTUAL_SHA256=$(sha256sum "$PACKAGE_NAME" | cut -d' ' -f1)
          
          if [ "$EXPECTED_SHA256" != "$ACTUAL_SHA256" ]; then
            echo "âŒ SHA256 checksum mismatch"
            echo "  Expected: $EXPECTED_SHA256"
            echo "  Actual:   $ACTUAL_SHA256"
            exit 1
          fi
          
          echo "ğŸ“¦ Package Validation Summary:"
          echo "  Package: $PACKAGE_NAME"
          echo "  Size: $(ls -lh "$PACKAGE_NAME" | awk '{print $5}')"
          echo "  Checksum: $CHECKSUM_NAME"
          echo "  SHA256: $ACTUAL_SHA256"
          echo "  ZIP Integrity: âœ… Valid"
          echo "  Checksum Verification: âœ… Valid"
          
          echo "âœ… Package validation completed successfully"

      # ç”Ÿæˆ Changelog
      - name: Generate changelog
        id: changelog
        run: |
          echo "ğŸ“ Generating changelog..."
          
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          REPO_NAME="${{ steps.version.outputs.repo_name }}"
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "^$TAG_NAME$" | head -n 1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ğŸ“‹ No previous tag found, generating changelog from first commit"
            COMMIT_RANGE=$(git rev-list --max-parents=0 HEAD)..HEAD
            PREVIOUS_TAG="Initial Release"
          else
            echo "ğŸ“‹ Previous tag: $PREVIOUS_TAG"
            COMMIT_RANGE="$PREVIOUS_TAG..$TAG_NAME"
          fi
          
          echo "ğŸ“Š Commit range: $COMMIT_RANGE"
          
          # è·å–æäº¤å†å²
          COMMITS=$(git log --pretty=format:"%h|%s|%an|%ad" --date=short "$COMMIT_RANGE" 2>/dev/null || git log --pretty=format:"%h|%s|%an|%ad" --date=short)
          
          if [ -z "$COMMITS" ]; then
            echo "âš ï¸  No commits found in range, creating minimal changelog"
            CHANGELOG_CONTENT="## What's Changed\n\n- Initial release of $REPO_NAME $TAG_NAME"
          else
            echo "ğŸ“ Processing commits for changelog generation..."
            
            # åˆå§‹åŒ–åˆ†ç±»æ•°ç»„
            FEATURES=""
            FIXES=""
            DOCS=""
            STYLE=""
            REFACTOR=""
            PERF=""
            TEST=""
            CHORE=""
            BREAKING=""
            OTHER=""
            
            # å¤„ç†æ¯ä¸ªæäº¤
            while IFS='|' read -r hash subject author date; do
              # è·³è¿‡ç©ºè¡Œ
              [ -z "$hash" ] && continue
              
              # è§£æ conventional commit æ ¼å¼ - ç®€åŒ–ç‰ˆæœ¬
              if [[ "$subject" =~ ^([a-zA-Z]+).*:\ (.+)$ ]]; then
                TYPE="${BASH_REMATCH[1]}"
                DESCRIPTION="${BASH_REMATCH[2]}"
                
                # æ£€æŸ¥æ˜¯å¦æœ‰ä½œç”¨åŸŸ
                if [[ "$subject" =~ ^[a-zA-Z]+\(([^)]+)\) ]]; then
                  SCOPE="(${BASH_REMATCH[1]})"
                else
                  SCOPE=""
                fi
                
                # æ£€æŸ¥ç ´åæ€§å˜æ›´æ ‡è®°
                if [[ "$subject" =~ ! ]] || echo "$subject" | grep -q "BREAKING CHANGE"; then
                  BREAKING_MARKER="!"
                else
                  BREAKING_MARKER=""
                fi
                
                # æ ¼å¼åŒ–æäº¤ä¿¡æ¯
                if [ -n "$SCOPE" ]; then
                  FORMATTED="- **${SCOPE#(}${SCOPE%)}**: $DESCRIPTION ([${hash}](https://github.com/${{ steps.version.outputs.full_repo }}/commit/${hash}))"
                else
                  FORMATTED="- $DESCRIPTION ([${hash}](https://github.com/${{ steps.version.outputs.full_repo }}/commit/${hash}))"
                fi
                
                # æ£€æŸ¥æ˜¯å¦ä¸ºç ´åæ€§å˜æ›´
                if [ "$BREAKING_MARKER" = "!" ] || echo "$subject" | grep -q "BREAKING CHANGE"; then
                  BREAKING="$BREAKING\n$FORMATTED"
                fi
                
                # æŒ‰ç±»å‹åˆ†ç±»
                case "$TYPE" in
                  "feat"|"feature")
                    FEATURES="$FEATURES\n$FORMATTED"
                    ;;
                  "fix"|"bugfix")
                    FIXES="$FIXES\n$FORMATTED"
                    ;;
                  "docs"|"doc")
                    DOCS="$DOCS\n$FORMATTED"
                    ;;
                  "style")
                    STYLE="$STYLE\n$FORMATTED"
                    ;;
                  "refactor")
                    REFACTOR="$REFACTOR\n$FORMATTED"
                    ;;
                  "perf"|"performance")
                    PERF="$PERF\n$FORMATTED"
                    ;;
                  "test")
                    TEST="$TEST\n$FORMATTED"
                    ;;
                  "chore"|"build"|"ci")
                    CHORE="$CHORE\n$FORMATTED"
                    ;;
                  *)
                    OTHER="$OTHER\n$FORMATTED"
                    ;;
                esac
              else
                # é conventional commit æ ¼å¼ï¼Œå½’ç±»ä¸ºå…¶ä»–
                FORMATTED="- $subject ([${hash}](https://github.com/${{ steps.version.outputs.full_repo }}/commit/${hash}))"
                OTHER="$OTHER\n$FORMATTED"
              fi
            done <<< "$COMMITS"
            
            # æ„å»º changelog å†…å®¹
            CHANGELOG_CONTENT="## What's Changed in $TAG_NAME"
            
            if [ "${{ steps.version.outputs.is_prerelease }}" = "true" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n\n> âš ï¸ **This is a pre-release version**. It may contain bugs or incomplete features."
            fi
            
            CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n"
            
            # æ·»åŠ ç ´åæ€§å˜æ›´ (æœ€é‡è¦ï¼Œæ”¾åœ¨æœ€å‰é¢)
            if [ -n "$BREAKING" ] && [ "$BREAKING" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### ğŸ’¥ Breaking Changes\n$BREAKING\n"
            fi
            
            # æ·»åŠ æ–°åŠŸèƒ½
            if [ -n "$FEATURES" ] && [ "$FEATURES" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### âœ¨ New Features\n$FEATURES\n"
            fi
            
            # æ·»åŠ  Bug ä¿®å¤
            if [ -n "$FIXES" ] && [ "$FIXES" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### ğŸ› Bug Fixes\n$FIXES\n"
            fi
            
            # æ·»åŠ æ€§èƒ½ä¼˜åŒ–
            if [ -n "$PERF" ] && [ "$PERF" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### âš¡ Performance Improvements\n$PERF\n"
            fi
            
            # æ·»åŠ é‡æ„
            if [ -n "$REFACTOR" ] && [ "$REFACTOR" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### â™»ï¸ Code Refactoring\n$REFACTOR\n"
            fi
            
            # æ·»åŠ æ–‡æ¡£æ›´æ–°
            if [ -n "$DOCS" ] && [ "$DOCS" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### ğŸ“š Documentation\n$DOCS\n"
            fi
            
            # æ·»åŠ æ ·å¼æ›´æ”¹
            if [ -n "$STYLE" ] && [ "$STYLE" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### ğŸ’„ Styles\n$STYLE\n"
            fi
            
            # æ·»åŠ æµ‹è¯•
            if [ -n "$TEST" ] && [ "$TEST" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### ğŸ§ª Tests\n$TEST\n"
            fi
            
            # æ·»åŠ æ„å»º/å·¥å…·å˜æ›´
            if [ -n "$CHORE" ] && [ "$CHORE" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### ğŸ”§ Chores\n$CHORE\n"
            fi
            
            # æ·»åŠ å…¶ä»–å˜æ›´
            if [ -n "$OTHER" ] && [ "$OTHER" != "" ]; then
              CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n### ğŸ“‹ Other Changes\n$OTHER\n"
            fi
          fi
          
          # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯å’Œç»Ÿè®¡
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)
          CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n---\n\n**Full Changelog**: https://github.com/${{ steps.version.outputs.full_repo }}/compare/${PREVIOUS_TAG}...${TAG_NAME}"
          
          if [ "$PREVIOUS_TAG" != "Initial Release" ]; then
            CHANGELOG_CONTENT="$CHANGELOG_CONTENT\n**Commits in this release**: $COMMIT_COUNT"
          fi
          
          # ä¿å­˜ changelog åˆ°æ–‡ä»¶
          echo -e "$CHANGELOG_CONTENT" > CHANGELOG.md
          
          # è¾“å‡ºåˆ° GitHub Actions
          {
            echo "changelog<<EOF"
            echo -e "$CHANGELOG_CONTENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ Changelog Summary:"
          echo "  Previous Tag: $PREVIOUS_TAG"
          echo "  Current Tag: $TAG_NAME"
          echo "  Commits Processed: $COMMIT_COUNT"
          echo "  Changelog Length: $(echo -e "$CHANGELOG_CONTENT" | wc -l) lines"
          
          echo "âœ… Changelog generated successfully"

      # æ˜¾ç¤ºç”Ÿæˆçš„ Changelog
      - name: Display changelog
        run: |
          echo "ğŸ“– Generated Changelog Preview:"
          echo "================================"
          cat CHANGELOG.md
          echo "================================"
          echo ""
          echo "ğŸ“Š Changelog Statistics:"
          echo "  Total lines: $(wc -l < CHANGELOG.md)"
          echo "  File size: $(ls -lh CHANGELOG.md | awk '{print $5}')"

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        id: create_release
        run: |
          echo "ğŸš€ Creating GitHub Release..."
          
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          RELEASE_TITLE="${{ steps.version.outputs.release_title }}"
          IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          CHECKSUM_NAME="${{ steps.version.outputs.checksum_name }}"
          
          echo "ğŸ“‹ Release Information:"
          echo "  Tag: $TAG_NAME"
          echo "  Title: $RELEASE_TITLE"
          echo "  Is Prerelease: $IS_PRERELEASE"
          echo "  Package: $PACKAGE_NAME"
          echo "  Checksums: $CHECKSUM_NAME"
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$PACKAGE_NAME" ]; then
            echo "âŒ Package file not found: $PACKAGE_NAME"
            exit 1
          fi
          
          if [ ! -f "$CHECKSUM_NAME" ]; then
            echo "âŒ Checksum file not found: $CHECKSUM_NAME"
            exit 1
          fi
          
          if [ ! -f "CHANGELOG.md" ]; then
            echo "âŒ Changelog file not found: CHANGELOG.md"
            exit 1
          fi
          
          # è¯»å– changelog å†…å®¹
          CHANGELOG_BODY=$(cat CHANGELOG.md)
          
          # åˆ›å»º Release
          echo "ğŸ“ Creating release with GitHub CLI..."
          
          RELEASE_ARGS="--title \"$RELEASE_TITLE\""
          RELEASE_ARGS="$RELEASE_ARGS --notes-file CHANGELOG.md"
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            RELEASE_ARGS="$RELEASE_ARGS --prerelease"
            echo "ğŸ”– Creating as pre-release"
          else
            echo "ğŸ”– Creating as stable release"
          fi
          
          # æ‰§è¡Œ Release åˆ›å»º
          eval "gh release create \"$TAG_NAME\" $RELEASE_ARGS"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Release created successfully"
            
            # è·å– Release URL
            RELEASE_URL=$(gh release view "$TAG_NAME" --json url --jq '.url')
            echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
            echo "ğŸ”— Release URL: $RELEASE_URL"
          else
            echo "âŒ Failed to create release"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      # ä¸Šä¼  Release èµ„äº§
      - name: Upload release assets
        run: |
          echo "ğŸ“¤ Uploading release assets..."
          
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          CHECKSUM_NAME="${{ steps.version.outputs.checksum_name }}"
          
          # ä¸Šä¼ ä¸»è¦çš„å‘å¸ƒåŒ…
          echo "ğŸ“¦ Uploading package: $PACKAGE_NAME"
          gh release upload "$TAG_NAME" "$PACKAGE_NAME" --clobber
          
          if [ $? -eq 0 ]; then
            echo "âœ… Package uploaded successfully"
          else
            echo "âŒ Failed to upload package"
            exit 1
          fi
          
          # ä¸Šä¼ æ ¡éªŒå’Œæ–‡ä»¶
          echo "ğŸ” Uploading checksums: $CHECKSUM_NAME"
          gh release upload "$TAG_NAME" "$CHECKSUM_NAME" --clobber
          
          if [ $? -eq 0 ]; then
            echo "âœ… Checksums uploaded successfully"
          else
            echo "âŒ Failed to upload checksums"
            exit 1
          fi
          
          # éªŒè¯ä¸Šä¼ ç»“æœ
          echo "ğŸ” Verifying uploaded assets..."
          ASSETS=$(gh release view "$TAG_NAME" --json assets --jq '.assets[].name')
          
          echo "ğŸ“‹ Uploaded assets:"
          echo "$ASSETS" | while read asset; do
            echo "  - $asset"
          done
          
          # æ£€æŸ¥å¿…è¦çš„èµ„äº§æ˜¯å¦éƒ½å·²ä¸Šä¼ 
          if echo "$ASSETS" | grep -q "$PACKAGE_NAME"; then
            echo "âœ… Package asset verified"
          else
            echo "âŒ Package asset missing"
            exit 1
          fi
          
          if echo "$ASSETS" | grep -q "$CHECKSUM_NAME"; then
            echo "âœ… Checksum asset verified"
          else
            echo "âŒ Checksum asset missing"
            exit 1
          fi
          
          echo "âœ… All assets uploaded and verified successfully"
        env:
          GH_TOKEN: ${{ github.token }}

      # å‘å¸ƒå®Œæˆæ€»ç»“
      - name: Release summary
        run: |
          echo "ğŸ‰ Release completed successfully!"
          echo "=================================="
          
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          RELEASE_URL="${{ steps.create_release.outputs.release_url }}"
          PACKAGE_NAME="${{ steps.version.outputs.package_name }}"
          CHECKSUM_NAME="${{ steps.version.outputs.checksum_name }}"
          
          echo "ğŸ“‹ Release Summary:"
          echo "  ğŸ·ï¸  Tag: $TAG_NAME"
          echo "  ğŸ“¦ Package: $PACKAGE_NAME"
          echo "  ğŸ” Checksums: $CHECKSUM_NAME"
          echo "  ğŸ”— URL: $RELEASE_URL"
          echo "  ğŸ“… Created: ${{ steps.version.outputs.timestamp }}"
          echo "  ğŸ¯ Type: ${{ steps.version.outputs.release_type }}"
          
          echo ""
          echo "ğŸ“¥ Download Instructions:"
          echo "  1. Visit: $RELEASE_URL"
          echo "  2. Download: $PACKAGE_NAME"
          echo "  3. Verify with: $CHECKSUM_NAME"
          echo ""
          echo "ğŸ”§ Quick Start:"
          echo "  1. Extract the ZIP file"
          echo "  2. Start a web server in the extracted directory"
          echo "  3. Open index.html in your browser"
          echo ""
          echo "âœ¨ Release $TAG_NAME is now available for download!"

    outputs:
      tag_name: ${{ steps.version.outputs.tag_name }}
      version: ${{ steps.version.outputs.version }}
      repo_name: ${{ steps.version.outputs.repo_name }}
      package_name: ${{ steps.version.outputs.package_name }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      release_exists: ${{ steps.check_release.outputs.exists }}